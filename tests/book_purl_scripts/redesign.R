## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# -------------------
# Power curve example
# -------------------

## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
design <-
  declare_model(N = N) +
  declare_measurement(Y = rbinom(n = N, size = 1, prob = 0.55)) +
  declare_test(
    handler =
      function(data) {
        test <- prop.test(x = table(data$Y), p = 0.5)
        tidy(test)
      }
  )


## ----eval = do_diagnosis & !exists("do_bookdown")------------------------------------------------------------------------------------------------------------------------------------------
diagnosis <- 
  design %>%
  redesign(N = seq(100, 1000, 100)) %>%
  diagnose_designs()


## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ----------------------------------------
# Redesign over multiple design parameters
# ----------------------------------------

## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
design <-
  declare_model(N = N, U = rnorm(N),
                potential_outcomes(Y ~ 0.2 * Z + U)) +
  declare_inquiry(ATE = mean(Y_Z_1 - Y_Z_0)) +
  declare_assignment(Z = complete_ra(N = N, prob = prob)) +
  declare_measurement(Y = reveal_outcomes(Y ~ Z)) +
  declare_estimator(Y ~ Z, inquiry = "ATE")


## ----eval = do_diagnosis & !exists("do_bookdown")------------------------------------------------------------------------------------------------------------------------------------------
diagnosands <-
  declare_diagnosands(cost = unique(N * 2 + prob * N * 20),
                      rmse = sqrt(mean((estimate - estimand) ^ 2)))

diagnosis <-
  design %>%
  redesign(N = seq(100, 1000, 50),
           prob = seq(0.1, 0.5, 0.2)) %>%
  diagnose_designs(diagnosands = diagnosands)


## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# -------------------------------
# Redesign over answer strategies
# -------------------------------

## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
design <-
  declare_model(
    N = 100,
    X = runif(N, 0, 3)) +
  declare_inquiry(handler = cef_inquiry) +
  declare_measurement(Y = dip(X) + rnorm(N, 0, .5)) +
  declare_estimator(handler = cef_estimator)


## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# --------------------------------
# Redesign under model uncertainty
# --------------------------------

## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
N <- 100
design <-
  declare_population(N = N, U = rnorm(N),
  # this runif(n = 1, min = 0, max = 0.5) generates 1 random ATE between 0 and 0.5
                     potential_outcomes(Y ~ runif(n = 1, min = 0, max = 0.5) * Z + U)) +
  declare_inquiry(ATE = mean(Y_Z_1 - Y_Z_0)) +
  declare_assignment(Z = complete_ra(N, prob = 0.5)) +
  declare_measurement(Y = reveal_outcomes(Y ~ Z)) +
  declare_estimator(Y ~ Z, inquiry = "ATE")


## ----eval = do_diagnosis & !exists("do_bookdown")------------------------------------------------------------------------------------------------------------------------------------------
designs <- redesign(design, N = c(100, 500, 1000))
simulations <- simulate_designs(designs, sims = 500)


## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# -------------------
# Redesigning in code
# -------------------

## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
designs <- list(design1, design2)


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
designs <- redesign(design, N = c(100, 200, 300))


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
designs <- diagnose_designs(designs)

