library(DeclareDesign); library(rdddr); library(tidyverse)

## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ---------------------------------
# Declaring models in code :: Units
# ---------------------------------

## ----results = "hide"----------------------------------------------------------------------------------------------------------------------------------------------------------------------
M <- declare_model(N = 1000)


## ----results = "hide"----------------------------------------------------------------------------------------------------------------------------------------------------------------------
M <- declare_model(
  households = add_level(
    N = 100, 
    N_members = sample(c(1, 2, 3, 4), N, 
                       prob = c(0.2, 0.3, 0.25, 0.25), replace = TRUE)
  ),
  individuals = add_level(
    N = N_members, 
    age = sample(18:90, N, replace = TRUE)
  )
)


## ----results = "hide"----------------------------------------------------------------------------------------------------------------------------------------------------------------------
M <- declare_model(
  countries = add_level(
    N = 196, 
    country_shock = rnorm(N)
  ),
  years = add_level(
    N = 100, 
    time_trend = 1:N,
    year_shock = runif(N, 1, 10), 
    nest = FALSE
  ),
  observation = cross_levels(
    by = join(countries, years),
    observation_shock = rnorm(N),
    Y = 0.01 * time_trend + country_shock + year_shock + observation_shock 
  )
)


## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------
# Declaring models in code :: Unit characteristics
# ------------------------------------------------

## ----results = "hide"----------------------------------------------------------------------------------------------------------------------------------------------------------------------
M <- 
  declare_model(
    N = 100, 
    X = runif(N, min = 0, max = 100)
  )


## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M <-
  declare_model(
    N = 1000,
    X1 = rnorm(N, mean = 5, sd = 2),
    X2 = runif(N, min = 0, max = 5),
    X3 = rbinom(N, size = 1, prob = 0.5),
    X4 = rbinom(N, size = 5, prob = 0.5),
    X5 = rlnorm(N, meanlog = 0, sdlog = 1),
    X6 = sample(c(1, 2, 3, 4, 5), N, replace = TRUE)
  ) 


## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M1 <- 
  declare_model(
    N = 1000, 
    Y = rbinom(N, 1, prob = 0.5)
  )


## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M2 <- 
  declare_model(
    N = 1000, 
    latent = runif(N, min = 0, max = 1),
    Y = rbinom(N, 1, prob = latent),
    Y2 = latent + rnorm(N)
  )


## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M3 <- 
  declare_model(
    N = 1000, 
    latent = runif(N, min = 0, max = 1), 
    Y = if_else(latent > 0.75, 1, 0)
  )


## ----results = "hide"----------------------------------------------------------------------------------------------------------------------------------------------------------------------
M1 <- 
  declare_model(
    N = 1000,
    X1 = rnorm(N),
    X2 = X1 + rnorm(N)
  )


## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M2 <- 
  declare_model(
    draw_multivariate(c(X1, X2) ~ MASS::mvrnorm(
      N, mu = c(0, 0),
      Sigma = matrix(c(1, 0.3, 0.3, 1), nrow = 2))
    )
  )


## ----results = "hide"----------------------------------------------------------------------------------------------------------------------------------------------------------------------
M <-
  declare_model(households = add_level(N = 1000),
                individuals = add_level(
                  N = 4,
                  X = draw_normal_icc(
                    mean = 0,
                    clusters = households,
                    ICC = 0.65
                  )
                ))


## ----results = "hide"----------------------------------------------------------------------------------------------------------------------------------------------------------------------
M <- 
  declare_model(
    data = baseline_data,
    attitudes = sample(1:5, N, replace = TRUE)
  )


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M <-
  declare_model(
    data = baseline_data, 
    N = 619505, 
    handler = resample_data
  )


## ----results = "hide"----------------------------------------------------------------------------------------------------------------------------------------------------------------------
M1 <- declare_model(
  N = 100,
  U = rnorm(N),
  X = rbinom(N, size = 1, prob = 0.5),
  Y = 0.1 * D + U
)


## ----results = "hide"----------------------------------------------------------------------------------------------------------------------------------------------------------------------
M2 <- declare_model(
  N = 100,
  U = rnorm(N),
  X = rbinom(N, size = 1, prob = pnorm(U)),
  Y = 0.1 * D + U
)


## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ----------------------------------------------
# Declaring models in code :: Potential outcomes
# ----------------------------------------------

## ----results = "hide"----------------------------------------------------------------------------------------------------------------------------------------------------------------------
M2 <- 
  declare_model(N = 100, 
                Y_Z_0 = rbinom(N, size = 1, prob = 0.5),
                Y_Z_1 = rbinom(N, size = 1, prob = 0.6)
                )


## ----results = "hide"----------------------------------------------------------------------------------------------------------------------------------------------------------------------
M <- 
  declare_model(N = 100, 
                potential_outcomes(Y ~ rbinom(N, size = 1, prob = 0.1 * Z + 0.5))
  )


## ----modelposdraw2, results = "hide"-------------------------------------------------------------------------------------------------------------------------------------------------------
M <- 
  declare_model(
    N = 100, 
    potential_outcomes(
      Y ~ rbinom(N, 1, prob = 0.1 * (Z == 1) + 0.2 * (Z == 2)), 
      conditions = list(Z = c(0, 1, 2))
    )
  )


## ----modelposdraw3, results = "hide"-------------------------------------------------------------------------------------------------------------------------------------------------------
M <- 
  declare_model(
    N = 100, 
    potential_outcomes(
      Y ~ rbinom(N, 1, prob = 0.1 * Z1 + 0.2 * Z2 + 0.1 * Z1 * Z2), 
      conditions = list(Z1 = c(0, 1), Z2 = c(0, 1))
    )
  )


## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
M <-
  declare_model(
    N = 100, 
    tau = runif(1, min = 0, max = 1), 
    U = rnorm(N), 
    potential_outcomes(Y ~ tau * Z + U)
  )


## ----results = "hide"----------------------------------------------------------------------------------------------------------------------------------------------------------------------
M <- 
  declare_model(
    N = 100, 
    U = rnorm(N), 
    X = rbinom(N, 1, prob = 0.5),
    potential_outcomes(Y ~  0.3 * Z + 0.2*X + 0.1*Z*X + U)
  )


## ----results = "hide"----------------------------------------------------------------------------------------------------------------------------------------------------------------------
M1 <- 
  declare_model(
    N = 100, 
    potential_outcomes(Y ~ rbinom(N, 1, prob = 0.2))
  )

M2 <- 
  declare_model(
    N = 100,
    latent = rnorm(N), 
    potential_outcomes(Y ~ rbinom(N, 1, prob = pnorm(latent + 0.2 * Z)))
  )

M3 <- 
  declare_model(
    N = 100, 
    latent = rnorm(N), 
    potential_outcomes(Y ~ if_else(latent + 0.2 * Z > 0.5, 1, 0))
  )


