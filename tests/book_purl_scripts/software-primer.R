## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------
# Installing R
# ------------

## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(DeclareDesign)
library(rdddr)


## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ----------------------------------
# Declaring research design elements
# ----------------------------------

## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
head(la_voter_file)


## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
simple_random_assignment <- 
  declare_assignment(Z = simple_ra(N = N, prob = 0.6))


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
simple_random_assignment(la_voter_file) 


## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ---------------------------------------------------------
# Declaring research design elements :: Model {#step-model}
# ---------------------------------------------------------

## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
declare_model(data = la_voter_file)


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
declare_model(N = 100, U = rnorm(N))


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
declare_model(
  N = 100,
  U = rnorm(N),
  Y_Z_0 = U, 
  Y_Z_1 = Y_Z_0 + 0.25
)


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
declare_model(
  N = 100,
  U = rnorm(N),
  potential_outcomes(Y ~ 0.25 * Z + U, conditions = list(Z = c(0, 1)))
)


## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# -------------------------------------------------------------
# Declaring research design elements :: Inquiry {#step-inquiry}
# -------------------------------------------------------------

## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
declare_inquiry(PATE = mean(Y_Z_1 - Y_Z_0))


## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# -------------------------------------------------------------------------
# Declaring research design elements :: Data strategy {#step-data-strategy}
# -------------------------------------------------------------------------

## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
declare_sampling(S = complete_rs(N, n = 50), filter = S == 1)


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
declare_assignment(Z = complete_ra(N, prob = 0.5))


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
declare_measurement(Y = reveal_outcomes(Y ~ Z))


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
declare_measurement(Y_binary = rbinom(N, 1, prob = pnorm(Y)))


## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# -----------------------------------------------------------------------------
# Declaring research design elements :: Answer strategy {#step-answer-strategy}
# -----------------------------------------------------------------------------

## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
declare_estimator(
  Y ~ Z, model = difference_in_means, inquiry = "PATE"
)


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
declare_estimator(
  Y ~ Z, model = lm_robust, model_summary = tidy
)


## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# --------------------------------------
# Building a design from design elements
# --------------------------------------

## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
model <- 
  declare_model(
    N = 100,
    U = rnorm(N),
    potential_outcomes(Y ~ 0.25 * Z + U)
  )

inquiry <- 
  declare_inquiry(PATE = mean(Y_Z_1 - Y_Z_0)) 

sampling <- 
  declare_sampling(S = complete_rs(N, n = 50)) 

assignment <- 
  declare_assignment(Z = complete_ra(N, prob = 0.5))

measurement <- 
  declare_measurement(Y = reveal_outcomes(Y ~ Z)) 

answer_strategy <- 
  declare_estimator(
    Y ~ Z, model = difference_in_means, inquiry = "PATE"
  )


## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
design <- 
  model + 
  inquiry + 
  sampling + assignment + measurement + 
  answer_strategy


## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
design <- 
  declare_model(N = 100, U = rnorm(N),
                potential_outcomes(Y ~ 0.25 * Z + U)) +
  declare_inquiry(PATE = mean(Y_Z_1 - Y_Z_0)) +
  declare_sampling(S = complete_rs(N, n = 50)) +
  declare_assignment(Z = complete_ra(N, prob = 0.5)) +
  declare_measurement(Y = reveal_outcomes(Y ~ Z)) +
  declare_estimator(
    Y ~ Z, model = difference_in_means, inquiry = "PATE"
  )


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
model +
  declare_inquiry(PATE = mean(Y_Z_1 - Y_Z_0)) +
  sampling +
  assignment +
  measurement +
  answer_strategy


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
model +
  sampling +
  declare_inquiry(SATE = mean(Y_Z_1 - Y_Z_0)) +
  assignment +
  measurement + 
  answer_strategy


## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ----------------------------
# Simulating a research design
# ----------------------------

## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
draw_data(design)


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
draw_estimands(design)


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
draw_estimates(design)


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
simulation_df <- simulate_design(design)
head(simulation_df)


## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# --------------------------------------------------------
# Diagnosing a research design {#diagnose-design-function}
# --------------------------------------------------------

## ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
study_diagnosands <-
  declare_diagnosands(
    bias = mean(estimate - estimand),
    rmse = sqrt(mean((estimate - estimand) ^ 2)),
    power = mean(p.value <= 0.05)
  )


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
diagnose_design(simulation_df, diagnosands = study_diagnosands)


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
diagnose_design(design, diagnosands = study_diagnosands)


## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# -----------------------------
# Redesign {#redesign-function}
# -----------------------------

## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
designs <- redesign(design, N = c(100, 200, 300, 400, 500))


## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
diagnose_design(designs)


## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------
# Library of designs
# ------------------

## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(DesignLibrary)

block_cluster_design <- block_cluster_two_arm_designer(N = 1000, N_blocks = 10)


## ---- echo = TRUE--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# --------------------
# Complex declarations
# --------------------

## ----eval = TRUE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
declare_inquiry(
 handler = function(data) {
   # start with data
   data %>%
     # split the dataset by city
     group_by(city) %>%
     # estimate city-level ATEs and return as a data.frame
     summarize(city_ATE = mean(Y_Z_1 - Y_Z_0), .groups = "drop")
 }
)

